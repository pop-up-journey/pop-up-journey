#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "ğŸš€ GitHub Flow Pre-commit checks..."

#0. íŠ¸ë ˆí‚¹
echo "ğŸ“ Staged files:"
git diff --cached --name-only --diff-filter=ACMR


# 1. ë³€ê²½ëœ íŒŒì¼ë§Œ Lint/Format
echo "ğŸ” Running lint-staged (with debug)..."
npx lint-staged --debug || {
  echo "âŒ Lint-staged failed! Aborting commit."
  exit 1
}

# 2. ë¹Œë“œ ì²´í¬
echo "ğŸ”¨ Running build check..."
if ! pnpm build; then
  echo "âŒ Build failed! Code is not deployable."
  exit 1
fi

# 3. í…ŒìŠ¤íŠ¸
if [ -f "package.json" ] && grep -q '"test"' package.json; then
  echo "ğŸ§ª Running tests..."
  if ! pnpm test; then
    echo "âŒ Tests failed!"
    exit 1
  fi
else
  echo "ğŸ“ No tests configured, skipping test step..."
fi

echo "âœ… All checks passed! Ready for GitHub Flow ğŸ‰"
